<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎉 Wedding Admin - Guest Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #993300 0%, #cc4400 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            background: #f8f9fa;
            margin: 20px 0;
            padding: 25px;
            border-radius: 10px;
            border-left: 5px solid #993300;
        }
        
        .section h2 {
            color: #993300;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .form-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: end;
        }
        
        .form-group input {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #993300;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group div {
            flex: 1;
        }
        
        .btn {
            background: #993300;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn:hover {
            background: #cc4400;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(153, 51, 0, 0.3);
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .guest-list {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }
        
        .guest-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .guest-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .guest-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .guest-code {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            color: #993300;
        }
        
        .guest-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }
        
        .guest-actions {
            display: flex;
            gap: 10px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #993300;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-weight: 600;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
        }
        
        .export-section {
            margin-top: 30px;
            text-align: center;
        }
        
        .code-output {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            .form-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .guest-item {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .guest-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎉 Wedding Guest Manager</h1>
            <p>Manage your wedding invitation guest list</p>
        </div>
        
        <div class="content">
            <!-- Statistics -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-guests">0</div>
                    <div class="stat-label">Total Guests</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="recent-adds">0</div>
                    <div class="stat-label">Added Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="invitation-links">0</div>
                    <div class="stat-label">Invitation Links</div>
                </div>
            </div>
            
            <!-- Add New Guest -->
            <div class="section">
                <h2>➕ Add New Guest</h2>
                <div class="alert alert-success" id="success-alert"></div>
                <div class="alert alert-error" id="error-alert"></div>
                
                <form id="add-guest-form">
                    <div class="form-group">
                        <div>
                            <label for="guest-code">Guest Code</label>
                            <input type="text" id="guest-code" placeholder="e.g., daniel, john, mary" required>
                        </div>
                        <div>
                            <label for="guest-name">Full Name</label>
                            <input type="text" id="guest-name" placeholder="e.g., Hoàng Danh" required>
                        </div>
                        <button type="submit" class="btn">Add Guest</button>
                    </div>
                </form>
            </div>
            
            <!-- Guest List -->
            <div class="section">
                <h2>👥 Guest List</h2>
                <div class="search-box">
                    <input type="text" id="search-guests" placeholder="🔍 Search guests by code or name...">
                </div>
                <div class="guest-list" id="guest-list">
                    <!-- Guests will be loaded here -->
                </div>
            </div>
            
            <!-- Export/Import -->
            <div class="section">
                <h2>💾 Export/Import</h2>
                <div class="export-section">
                    <button class="btn btn-success" onclick="exportGuests()">📤 Export Guest Data</button>
                    <button class="btn" onclick="generateCode()">🔧 Generate Code for index.html</button>
                    <a href="index.html" class="btn" target="_blank">👀 Preview Wedding Page</a>
                </div>
                <div class="code-output" id="code-output" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // Guest Management System
        class GuestManager {
            constructor() {
                // Initialize with the same data as in index.html
                this.guests = new Map([
                    ['daniel', 'Hoàng Danh'],
                    ['john', 'Nguyễn Văn An'],
                    ['mary', 'Trần Thị Bình'],
                    ['peter', 'Lê Văn Cường'],
                    ['anna', 'Phạm Thị Dung'],
                    ['michael', 'Võ Minh Tuấn'],
                    ['sarah', 'Nguyễn Thị Lan'],
                    ['david', 'Trần Văn Đức'],
                    ['lisa', 'Lê Thị Mai'],
                    ['robert', 'Phạm Văn Nam']
                ]);
                
                this.loadFromLocalStorage();
                this.init();
            }
            
            init() {
                this.renderGuestList();
                this.updateStats();
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                // Add guest form
                document.getElementById('add-guest-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addGuest();
                });
                
                // Search functionality
                document.getElementById('search-guests').addEventListener('input', (e) => {
                    this.filterGuests(e.target.value);
                });
            }
            
            addGuest() {
                const codeInput = document.getElementById('guest-code');
                const nameInput = document.getElementById('guest-name');
                
                const code = codeInput.value.trim().toLowerCase();
                const name = nameInput.value.trim();
                
                if (!code || !name) {
                    this.showAlert('Please fill in both guest code and name!', 'error');
                    return;
                }
                
                if (this.guests.has(code)) {
                    this.showAlert(`Guest code "${code}" already exists!`, 'error');
                    return;
                }
                
                // Validate code format (no special characters except hyphen and underscore)
                if (!/^[a-z0-9_-]+$/.test(code)) {
                    this.showAlert('Guest code can only contain letters, numbers, hyphens, and underscores!', 'error');
                    return;
                }
                
                this.guests.set(code, name);
                this.saveToLocalStorage();
                this.renderGuestList();
                this.updateStats();
                
                // Clear form
                codeInput.value = '';
                nameInput.value = '';
                
                this.showAlert(`✅ Guest "${name}" (${code}) added successfully!`, 'success');
                
                // Focus back to code input for quick adding
                codeInput.focus();
            }
            
            removeGuest(code) {
                if (confirm(`Are you sure you want to remove "${this.guests.get(code)}" (${code})?`)) {
                    const name = this.guests.get(code);
                    this.guests.delete(code);
                    this.saveToLocalStorage();
                    this.renderGuestList();
                    this.updateStats();
                    this.showAlert(`❌ Guest "${name}" removed successfully!`, 'success');
                }
            }
            
            editGuest(code) {
                const currentName = this.guests.get(code);
                const newName = prompt(`Edit guest name for "${code}":`, currentName);
                
                if (newName && newName.trim() && newName.trim() !== currentName) {
                    this.guests.set(code, newName.trim());
                    this.saveToLocalStorage();
                    this.renderGuestList();
                    this.showAlert(`✏️ Guest "${code}" updated successfully!`, 'success');
                }
            }
            
            renderGuestList(filter = '') {
                const container = document.getElementById('guest-list');
                const guests = Array.from(this.guests.entries());
                
                // Filter guests
                const filteredGuests = guests.filter(([code, name]) => 
                    code.toLowerCase().includes(filter.toLowerCase()) || 
                    name.toLowerCase().includes(filter.toLowerCase())
                );
                
                if (filteredGuests.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No guests found. Add some guests to get started!</p>';
                    return;
                }
                
                container.innerHTML = filteredGuests.map(([code, name]) => `
                    <div class="guest-item">
                        <div class="guest-info">
                            <div class="guest-code">${code}</div>
                            <div class="guest-name">${name}</div>
                        </div>
                        <div class="guest-actions">
                            <button class="btn" onclick="copyInvitationLink('${code}')">📋 Copy Link</button>
                            <button class="btn" onclick="guestManager.editGuest('${code}')">✏️ Edit</button>
                            <button class="btn btn-danger" onclick="guestManager.removeGuest('${code}')">🗑️ Delete</button>
                        </div>
                    </div>
                `).join('');
            }
            
            filterGuests(filter) {
                this.renderGuestList(filter);
            }
            
            updateStats() {
                document.getElementById('total-guests').textContent = this.guests.size;
                document.getElementById('recent-adds').textContent = this.getTodayAdds();
                document.getElementById('invitation-links').textContent = this.guests.size;
            }
            
            getTodayAdds() {
                // This is a placeholder - in a real app, you'd track timestamps
                return '0';
            }
            
            showAlert(message, type) {
                const alertElement = document.getElementById(`${type === 'error' ? 'error' : 'success'}-alert`);
                alertElement.textContent = message;
                alertElement.style.display = 'block';
                
                // Hide other alert
                const otherAlert = document.getElementById(`${type === 'error' ? 'success' : 'error'}-alert`);
                otherAlert.style.display = 'none';
                
                // Auto hide after 5 seconds
                setTimeout(() => {
                    alertElement.style.display = 'none';
                }, 5000);
            }
            
            saveToLocalStorage() {
                const guestArray = Array.from(this.guests.entries());
                localStorage.setItem('wedding-guests', JSON.stringify(guestArray));
            }
            
            loadFromLocalStorage() {
                const saved = localStorage.getItem('wedding-guests');
                if (saved) {
                    try {
                        const guestArray = JSON.parse(saved);
                        this.guests = new Map(guestArray);
                    } catch (e) {
                        console.warn('Could not load saved guests:', e);
                    }
                }
            }
            
            exportData() {
                return Array.from(this.guests.entries());
            }
        }
        
        // Global functions
        let guestManager;
        
        function copyInvitationLink(code) {
            const baseUrl = window.location.origin + window.location.pathname.replace('admin.html', 'index.html');
            const link = `${baseUrl}?g=${code}`;
            
            navigator.clipboard.writeText(link).then(() => {
                guestManager.showAlert(`📋 Invitation link copied for "${code}"!`, 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = link;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                guestManager.showAlert(`📋 Invitation link copied for "${code}"!`, 'success');
            });
        }
        
        function exportGuests() {
            const guests = guestManager.exportData();
            const data = guests.map(([code, name]) => `${code}=${name}`).join('\n');
            
            const blob = new Blob([data], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'wedding-guests.txt';
            a.click();
            URL.revokeObjectURL(url);
            
            guestManager.showAlert('✅ Guest data exported successfully!', 'success');
        }
        
        function generateCode() {
            const guests = guestManager.exportData();
            const codeOutput = document.getElementById('code-output');
            
            const code = `// Updated guest data for index.html
this.guestData = new Map([
${guests.map(([code, name]) => `  ['${code}', '${name}']`).join(',\n')}
]);`;
            
            codeOutput.textContent = code;
            codeOutput.style.display = 'block';
            
            guestManager.showAlert('📝 JavaScript code generated! Copy and paste into index.html', 'success');
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            guestManager = new GuestManager();
        });
    </script>
</body>
</html>
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <h1>🎉 Wedding Invitation - Guest Name System Test</h1>
    
    <div class="test-section">
        <h2>📝 How it works:</h2>
        <ol>
            <li>Add guest codes and names to <code>guests.txt</code></li>
            <li>Use URL parameter <code>?g=guestcode</code> to personalize the invitation</li>
            <li>The system will replace "Quý khách" with the guest's actual name</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>🔗 Test Links:</h2>
        <div class="guest-links">
            <a href="index.html" class="guest-link">Default (Quý khách)</a>
            <a href="index.html?g=daniel" class="guest-link">Daniel → Hoàng Danh</a>
            <a href="index.html?g=john" class="guest-link">John → Nguyễn Văn An</a>
            <a href="index.html?g=mary" class="guest-link">Mary → Trần Thị Bình</a>
            <a href="index.html?g=peter" class="guest-link">Peter → Lê Văn Cường</a>
            <a href="index.html?g=anna" class="guest-link">Anna → Phạm Thị Dung</a>
            <a href="index.html?g=invalid" class="guest-link">Invalid Code</a>
        </div>
    </div>

    <div class="test-section">
        <h2>💾 Current Guest Database:</h2>
        <div id="guest-list">Loading...</div>
    </div>

    <div class="status">
        <h3>🔍 Debug Information:</h3>
        <div id="debug-info">
            <p><strong>Current URL:</strong> <span id="current-url"></span></p>
            <p><strong>Guest Code:</strong> <span id="guest-code"></span></p>
            <p><strong>Expected Name:</strong> <span id="expected-name"></span></p>
        </div>
    </div>

    <script>
        // Update debug info
        function updateDebugInfo() {
            const urlParams = new URLSearchParams(window.location.search);
            const guestCode = urlParams.get('g');
            
            document.getElementById('current-url').textContent = window.location.href;
            document.getElementById('guest-code').textContent = guestCode || 'None';
            document.getElementById('expected-name').textContent = guestCode ? `Check guests.txt for "${guestCode}"` : 'Default "Quý khách"';
        }

        // Load and display guest list
        async function loadGuestList() {
            try {
                // If guestHandler is available from the main page, use it
                if (window.guestHandler) {
                    const guests = window.guestHandler.getAllGuests();
                    displayGuestList(guests);
                    return;
                }
                
                // Otherwise, try to load from file or use embedded data
                let guestData = [];
                
                try {
                    // Try to load from file if not on file:// protocol
                    if (window.location.protocol !== 'file:') {
                        const response = await fetch('guests.txt');
                        const text = await response.text();
                        const lines = text.split('\n');
                        
                        lines.forEach(line => {
                            const trimmedLine = line.trim();
                            if (trimmedLine && !trimmedLine.startsWith('#')) {
                                const [code, name] = trimmedLine.split('=');
                                if (code && name) {
                                    guestData.push({ code: code.trim(), name: name.trim() });
                                }
                            }
                        });
                    } else {
                        throw new Error('File protocol detected');
                    }
                } catch (fileError) {
                    // Use embedded data as fallback
                    guestData = [
                        { code: 'daniel', name: 'Hoàng Danh' },
                        { code: 'john', name: 'Nguyễn Văn An' },
                        { code: 'mary', name: 'Trần Thị Bình' },
                        { code: 'peter', name: 'Lê Văn Cường' },
                        { code: 'anna', name: 'Phạm Thị Dung' },
                        { code: 'michael', name: 'Võ Minh Tuấn' },
                        { code: 'sarah', name: 'Nguyễn Thị Lan' },
                        { code: 'david', name: 'Trần Văn Đức' },
                        { code: 'lisa', name: 'Lê Thị Mai' },
                        { code: 'robert', name: 'Phạm Văn Nam' }
                    ];
                    console.log('Using embedded guest data for test page');
                }
                
                displayGuestList(guestData);
                
            } catch (error) {
                document.getElementById('guest-list').innerHTML = `<p style="color: red;">Error loading guest list: ${error.message}</p>`;
            }
        }
        
        function displayGuestList(guests) {
            let guestListHtml = '<ul>';
            
            guests.forEach(guest => {
                guestListHtml += `<li><code>${guest.code}</code> → ${guest.name}</li>`;
            });
            
            guestListHtml += '</ul>';
            guestListHtml = `<p>Total guests: <strong>${guests.length}</strong></p>` + guestListHtml;
            
            document.getElementById('guest-list').innerHTML = guestListHtml;
        }

        // Initialize
        updateDebugInfo();
        loadGuestList();
    </script>
</body>
</html>
